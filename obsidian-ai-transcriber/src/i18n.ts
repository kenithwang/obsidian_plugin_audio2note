import { getLanguage } from 'obsidian';

type Locale = 'en' | 'zh';

const STRINGS = {
	en: {
		statusIdle: 'Transcriber Idle',
		statusRecording: 'Recording...',
		statusRecordingPaused: 'Recording Paused',
		statusSavingRecording: 'Saving recording...',
		statusTranscribing: 'AI Transcribing...',
		statusTranscribingProgress: 'Transcribing {current}/{total}...',
		statusEditing: 'AI Editing...',
		statusEditingSummary: 'Editing summary...',
		statusCancelled: 'Task cancelled',
		statusCancelButton: 'Cancel',
		noticeTaskCancelled: 'Task cancelled.',
		noticeTaskAlreadyRunning: 'Another AI task is running. Please wait or cancel it first.',
		noticeRecordingStarted: 'Recording started',
		noticeRecordingPaused: 'Recording paused',
		noticeRecordingResumed: 'Recording resumed',
		noticeStoppingRecording: 'Stopping recording...',
		noticeSavingRecording: 'Saving recording...',
		noticeTranscribingAudio: 'Transcribing audio...',
		noticeEditingWithTemplate: 'Editing transcript with AI using template: {name}',
		noticeEditingWithSelectedTemplate: 'Editing transcript with AI using the selected template.',
		noticeTemplateSelectionCancelledEditing: 'Template selection cancelled. Editing aborted.',
		noticeTemplateSelectionCancelledTranscribe: 'Template selection cancelled. Transcription aborted.',
		noticeTemplateSelectionCancelledAudioSaved: 'Template selection cancelled. Audio saved, transcription aborted.',
		noticeTemplateNotFoundEditing: 'Selected template not found. Editing aborted.',
		noticeTemplateNotFoundTranscribe: 'Selected template not found. Transcription aborted.',
		noticeTemplateNotFoundAudioSaved: 'Selected template not found. Audio saved, transcription aborted.',
		noticePleaseOpenMarkdown: 'Please open a Markdown file to edit.',
		noticeEmptyFile: 'The file is empty.',
		noticeEditorDisabled: 'AI Editor is not enabled in settings. Editing skipped.',
		noticeRawTranscriptSaved: 'Raw transcript saved to {path}',
		noticeTranscriptSaved: 'Transcript saved to {path}',
		noticeEditedTranscriptSaved: 'Edited transcript saved to {path}',
		noticeRecordingSaved: 'Recording saved to {path}',
		noticeError: 'Error: {message}',
		noticeErrorEditing: 'Error editing transcript: {message}',
		noticeErrorTranscribeEdit: 'Error during transcription/editing: {message}',
		noticeErrorTranscribe: 'Error during transcription: {message}',
		noticeErrorSavingRecording: 'Error saving recording: {message}',
		noticeErrorStartingRecording: 'Error starting recording: {message}',
		templateSelectTitle: 'Select System Prompt Template',
		templateLabel: 'Template',
		templateDesc: 'Choose a system prompt template for the editor.',
		participantsLabel: 'Participants',
		participantsDesc: 'Select participants or add new people.',
		participantsAdd: 'Add Participant',
		participantsEmpty: 'No participants yet. Please add one first.',
		participantsEdit: 'Edit',
		participantsDelete: 'Delete',
		participantsDeleteConfirmTitle: 'Confirm deletion',
		participantsDeleteConfirmText: 'Delete "{name}"?',
		cancel: 'Cancel',
		confirm: 'Confirm',
		meetingPurposeLabel: 'Meeting purpose (optional)',
		meetingPurposeDesc: 'Briefly describe this meeting purpose/background.',
		meetingPurposePlaceholder: 'Optional, short description...',
		contextParticipantsTitle: 'Participants:',
		contextPurposeTitle: 'Meeting purpose:',
		participantModalAddTitle: 'Add Participant',
		participantModalEditTitle: 'Edit Participant',
		participantName: 'Name',
		participantNameDesc: 'Required',
		participantNamePlaceholder: 'Name',
		participantOrg: 'Organization/Company',
		participantOrgDesc: 'Optional',
		participantOrgPlaceholder: 'Organization',
		participantIntro: 'Participant Intro',
		participantIntroDesc: 'Short role/profile used for recognition',
		participantIntroPlaceholder: 'Example: Product lead, responsible for XX',
		save: 'Save',
		participantNameEmpty: 'Name cannot be empty',
		settingsTemplateImportExport: 'Template Import / Export',
		settingsTemplateImportExportDesc: 'Export templates to JSON, or import templates from a JSON file.',
		settingsExportTemplates: 'Export JSON',
		settingsImportTemplates: 'Import JSON',
		noticeTemplatesExported: 'Templates exported: {filename}',
		noticeTemplateImportReadFailed: 'Failed to read template file.',
		noticeTemplateImportInvalid: 'Invalid template JSON format.',
		noticeTemplateImportEmpty: 'No valid templates found in imported file.',
		noticeTemplateImportSuccess: 'Imported {count} template(s).',
	},
	zh: {
		statusIdle: '转录器空闲',
		statusRecording: '录音中...',
		statusRecordingPaused: '录音已暂停',
		statusSavingRecording: '保存录音中...',
		statusTranscribing: 'AI 转录中...',
		statusTranscribingProgress: '转录中 {current}/{total}...',
		statusEditing: 'AI 编辑中...',
		statusEditingSummary: '摘要生成中...',
		statusCancelled: '任务已取消',
		statusCancelButton: '取消',
		noticeTaskCancelled: '任务已取消。',
		noticeTaskAlreadyRunning: '另一个 AI 任务正在运行，请先等待完成或先取消。',
		noticeRecordingStarted: '开始录音',
		noticeRecordingPaused: '录音已暂停',
		noticeRecordingResumed: '录音已继续',
		noticeStoppingRecording: '正在停止录音...',
		noticeSavingRecording: '正在保存录音...',
		noticeTranscribingAudio: '正在转录音频...',
		noticeEditingWithTemplate: '正在使用模板进行 AI 编辑：{name}',
		noticeEditingWithSelectedTemplate: '正在使用所选模板进行 AI 编辑。',
		noticeTemplateSelectionCancelledEditing: '已取消模板选择，编辑已中止。',
		noticeTemplateSelectionCancelledTranscribe: '已取消模板选择，转录已中止。',
		noticeTemplateSelectionCancelledAudioSaved: '已取消模板选择，音频已保存，转录已中止。',
		noticeTemplateNotFoundEditing: '未找到所选模板，编辑已中止。',
		noticeTemplateNotFoundTranscribe: '未找到所选模板，转录已中止。',
		noticeTemplateNotFoundAudioSaved: '未找到所选模板，音频已保存，转录已中止。',
		noticePleaseOpenMarkdown: '请先打开一个 Markdown 文件再编辑。',
		noticeEmptyFile: '当前文件为空。',
		noticeEditorDisabled: '设置中未启用 AI 编辑，已跳过。',
		noticeRawTranscriptSaved: '原始逐字稿已保存到 {path}',
		noticeTranscriptSaved: '逐字稿已保存到 {path}',
		noticeEditedTranscriptSaved: '编辑后逐字稿已保存到 {path}',
		noticeRecordingSaved: '录音已保存到 {path}',
		noticeError: '错误：{message}',
		noticeErrorEditing: '编辑逐字稿出错：{message}',
		noticeErrorTranscribeEdit: '转录/编辑过程中出错：{message}',
		noticeErrorTranscribe: '转录过程中出错：{message}',
		noticeErrorSavingRecording: '保存录音出错：{message}',
		noticeErrorStartingRecording: '开始录音出错：{message}',
		templateSelectTitle: '选择系统提示词模板',
		templateLabel: '模板',
		templateDesc: '为编辑器选择一个系统提示词模板。',
		participantsLabel: '参会人员',
		participantsDesc: '选择参会人员，或新增人物。',
		participantsAdd: '新增人物',
		participantsEmpty: '暂无参会人员，请先新增。',
		participantsEdit: '编辑',
		participantsDelete: '删除',
		participantsDeleteConfirmTitle: '确认删除',
		participantsDeleteConfirmText: '确定要删除 "{name}" 吗？',
		cancel: '取消',
		confirm: '确认',
		meetingPurposeLabel: '参会目的（可选）',
		meetingPurposeDesc: '简要说明本次会议目的/背景。',
		meetingPurposePlaceholder: '可选，简要描述...',
		contextParticipantsTitle: '参会人员：',
		contextPurposeTitle: '会议目的：',
		participantModalAddTitle: '新增人物',
		participantModalEditTitle: '编辑人物',
		participantName: '姓名',
		participantNameDesc: '必填',
		participantNamePlaceholder: '姓名',
		participantOrg: '组织/公司',
		participantOrgDesc: '可选',
		participantOrgPlaceholder: '组织',
		participantIntro: '人物介绍',
		participantIntroDesc: '简要身份/职责，用于识别',
		participantIntroPlaceholder: '如：产品负责人，负责XX',
		save: '保存',
		participantNameEmpty: '姓名不能为空',
		settingsTemplateImportExport: '模板导入 / 导出',
		settingsTemplateImportExportDesc: '将模板导出为 JSON，或从 JSON 文件导入模板。',
		settingsExportTemplates: '导出 JSON',
		settingsImportTemplates: '导入 JSON',
		noticeTemplatesExported: '模板已导出：{filename}',
		noticeTemplateImportReadFailed: '读取模板文件失败。',
		noticeTemplateImportInvalid: '模板 JSON 格式无效。',
		noticeTemplateImportEmpty: '导入文件中没有有效模板。',
		noticeTemplateImportSuccess: '已导入 {count} 个模板。',
	},
} as const;

type TranslationKey = keyof (typeof STRINGS)['en'];
type TranslationParams = Record<string, string | number>;

function resolveLocale(): Locale {
	try {
		return getLanguage().toLowerCase().startsWith('zh') ? 'zh' : 'en';
	} catch {
		return 'en';
	}
}

export function t(key: TranslationKey, params?: TranslationParams): string {
	let template: string = STRINGS[resolveLocale()][key] ?? STRINGS.en[key];
	if (!params) return template;
	for (const [name, value] of Object.entries(params)) {
		template = template.replace(new RegExp(`\\{${name}\\}`, 'g'), String(value));
	}
	return template;
}
